name: Test Docker Compose Setup

on:
  push:
    branches: [ dev, master]
  pull_request:
    branches: [  master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_USER=root
          POSTGRES_PASSWORD=j4j4j4jnn
          POSTGRES_DB=n8n
          N8N_ENCRYPTION_KEY=$(openssl rand -hex 32)
          N8N_USER_MANAGEMENT_JWT_SECRET=$(openssl rand -hex 32)
          N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
          N8N_DEFAULT_BINARY_DATA_MODE=filesystem
          OLLAMA_HOST=ollama:11434
          EOF

      - name: Create shared directory
        run: mkdir -p shared

      - name: Validate docker-compose.yml
        run: |
          docker compose config > /dev/null
          echo "docker-compose.yml is valid!"

      - name: Start services with CPU profile
        run: |
          docker compose --profile cpu up -d

      - name: Wait for PostgreSQL to be healthy
        run: |
          echo "Waiting for PostgreSQL to be healthy..."
          timeout 120 bash -c 'until docker compose ps postgres | grep -q "healthy"; do sleep 2; done' || (echo "PostgreSQL health check failed. Logs:"; docker compose logs postgres; exit 1)
          echo "PostgreSQL is healthy!"

      - name: Wait for n8n-import to complete
        continue-on-error: true
        run: |
          echo "Waiting for n8n-import to complete..."
          timeout 30 bash -c 'until docker compose ps n8n-import | grep -q "Exited"; do sleep 5; done' || (echo "WARNING: n8n-import timed out. Logs:"; docker compose logs n8n-import; exit 0)
          echo "Checking import logs for success..."
          if docker compose logs n8n-import | grep -q "Successfully imported"; then
            echo "n8n-import completed successfully (workflows imported)!"
          else
            echo "WARNING: n8n-import may have failed. Logs:"
            docker compose logs n8n-import
            echo "Continuing despite n8n-import check failure..."
          fi

      - name: Wait for n8n to start
        run: |
          echo "Waiting for n8n to be ready..."
          timeout 120 bash -c 'until curl -f http://localhost:5678/healthz 2>/dev/null || docker compose ps n8n | grep -q "Up"; do sleep 5; done'
          echo "n8n is running!"

      - name: Wait for Qdrant to be ready
        run: |
          echo "Waiting for Qdrant to be ready..."
          sleep 20
          docker compose ps qdrant | grep -q "Up" || (echo "Qdrant container not running. Status:"; docker compose ps qdrant; exit 1)
          echo "Qdrant is ready!"

      - name: Wait for Ollama to be ready
        run: |
          echo "Waiting for Ollama to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:11434/api/tags 2>/dev/null; do sleep 2; done'
          echo "Ollama is ready!"
        continue-on-error: true

      - name: Test PostgreSQL connection
        run: |
          docker compose exec -T postgres pg_isready -U testuser -d testdb
          echo "PostgreSQL connection test passed!"

      - name: Test Qdrant API
        run: |
          curl -f http://localhost:6333/collections
          echo "Qdrant API test passed!"

      - name: Test Ollama API
        run: |
          curl -f http://localhost:11434/api/tags
          echo "Ollama API test passed!"
        continue-on-error: true

      - name: Test n8n health endpoint
        run: |
          # n8n might take a while to fully start, so we'll try the health endpoint
          # or check if the service is running
          if curl -f http://localhost:5678/healthz 2>/dev/null; then
            echo "n8n health endpoint accessible!"
          else
            echo "Checking n8n service status..."
            docker compose ps n8n
            docker compose logs --tail=50 n8n
            # Even if health endpoint isn't available, check if service is running
            docker compose ps n8n | grep -q "Up" || exit 1
            echo "n8n service is running!"
          fi

      - name: Check service status
        run: |
          echo "=== Service Status ==="
          docker compose ps
          echo ""
          echo "=== Service Logs (last 20 lines) ==="
          docker compose logs --tail=20

      - name: Cleanup
        if: always()
        run: |
          docker compose --profile cpu down -v
