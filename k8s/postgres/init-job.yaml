---
# One-time Job: creates the 'keycloak' database in PostgreSQL.
# Idempotent — safe to run multiple times.
# Run with: kubectl apply -f k8s/postgres/init-job.yaml -n google-rag
apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-init
  namespace: google-rag
  labels:
    app: postgres-init
spec:
  ttlSecondsAfterFinished: 600  # Auto-delete 10 min after completion
  backoffLimit: 6
  template:
    metadata:
      labels:
        app: postgres-init
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-postgres
          image: postgres:16-alpine
          command:
            - /bin/sh
            - -c
            - |
              until pg_isready -h postgres -p 5432 -U "$POSTGRES_USER"; do
                echo "Waiting for PostgreSQL..."; sleep 3
              done
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: n8n-rag-secrets
                  key: POSTGRES_USER
      containers:
        - name: create-keycloak-db
          image: postgres:16-alpine
          command:
            - /bin/sh
            - -c
            - |
              echo "Checking if 'keycloak' database exists..."
              EXISTS=$(psql -h postgres -U "$POSTGRES_USER" -d "$POSTGRES_DB" \
                -tAc "SELECT 1 FROM pg_database WHERE datname='keycloak'")
              if [ "$EXISTS" = "1" ]; then
                echo "Database 'keycloak' already exists — skipping."
              else
                echo "Creating 'keycloak' database..."
                psql -h postgres -U "$POSTGRES_USER" -d "$POSTGRES_DB" \
                  -c "CREATE DATABASE keycloak;"
                psql -h postgres -U "$POSTGRES_USER" -d "$POSTGRES_DB" \
                  -c "GRANT ALL PRIVILEGES ON DATABASE keycloak TO \"$POSTGRES_USER\";"
                echo "Done."
              fi
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: n8n-rag-secrets
                  key: POSTGRES_USER
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: n8n-rag-secrets
                  key: POSTGRES_DB
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: n8n-rag-secrets
                  key: POSTGRES_PASSWORD
          resources:
            requests:
              memory: 64Mi
              cpu: 50m
            limits:
              memory: 128Mi
              cpu: 200m
