apiVersion: v1
kind: ConfigMap
metadata:
  name: oauth2-proxy-config
  namespace: google-rag
  labels:
    app: oauth2-proxy
data:
  oauth2-proxy.cfg: |
    # ============================================================
    # oauth2-proxy — Authentication gateway for n8n
    # Configured as an auth-check service (nginx external auth).
    # Nginx routes /n8n/ directly to n8n but checks every request
    # against oauth2-proxy's /oauth2/auth endpoint first.
    # ============================================================

    # HTTP listener
    http_address = "0.0.0.0:4180"

    # Keycloak OIDC provider
    provider = "keycloak-oidc"

    # IMPORTANT: Must match the client configured in Keycloak realm.
    # Keycloak lives at goodmanreunion.duckdns.org/keycloak (separate cluster deployment).
    # The n8n-rag realm is imported there via k8s/keycloak/realm-import-job.yaml.
    client_id = "n8n-oauth2-proxy"
    oidc_issuer_url = "https://goodmanreunion.duckdns.org/keycloak/realms/n8n-rag"
    redirect_url = "https://rawhideron.duckdns.org/oauth2/callback"

    # Static upstream — oauth2-proxy acts as auth-check, not a proxy.
    # Nginx forwards authenticated traffic directly to n8n.
    upstreams = ["static://202"]

    # Cookie settings
    cookie_name    = "_oauth2_proxy_n8n"
    cookie_secure  = true
    cookie_domains = ["rawhideron.duckdns.org"]
    cookie_expire  = "12h"
    cookie_refresh = "1h"

    # Allow any email domain (registration is controlled by Keycloak)
    email_domains = ["*"]

    # Don't reject users whose Keycloak email isn't marked verified.
    # Email verification is managed in Keycloak — trusting its authentication is sufficient.
    insecure_oidc_allow_unverified_email = true

    # Pass authenticated user info in response headers
    # nginx-ingress forwards these to n8n
    pass_user_headers    = true
    set_xauthrequest     = true
    pass_access_token    = false

    # Don't show the oauth2-proxy login page — go straight to Keycloak
    skip_provider_button = true

    # Logging
    silence_ping_logging = true
